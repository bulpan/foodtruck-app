package com.foodtruck.app

import android.Manifest
import android.app.NotificationChannel
import android.app.NotificationManager
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.os.Build
import android.os.Bundle
import android.util.Log
import android.view.WindowInsets
import android.view.WindowInsetsController
import android.webkit.WebView
import android.webkit.WebViewClient
import android.webkit.WebSettings
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.result.contract.ActivityResultContracts
import androidx.core.view.WindowCompat
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.background
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.viewinterop.AndroidView
import androidx.core.content.ContextCompat
import androidx.lifecycle.viewmodel.compose.viewModel
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.LaunchedEffect
import com.foodtruck.app.ui.viewmodel.MainViewModel

import com.foodtruck.app.ui.viewmodel.ApiService
import com.foodtruck.app.config.AppConfig
import com.google.firebase.messaging.FirebaseMessaging
import androidx.activity.OnBackPressedCallback
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import com.google.gson.Gson
import com.google.gson.JsonObject
import com.google.gson.JsonArray
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.foundation.clickable
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.ui.unit.sp
import com.foodtruck.app.R

// ì•Œë¦¼ ì„¤ì • ë°ì´í„° í´ë˜ìŠ¤
data class NotificationSettings(
    val notificationEnabled: Boolean = true,
    val locationNotificationEnabled: Boolean = true
)

class MainActivity : ComponentActivity() {
    
    private var currentWebView: WebView? = null
    
    // í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ëŸ°ì²˜
    private val requestPermissionLauncher = registerForActivityResult(
        ActivityResultContracts.RequestPermission()
    ) { isGranted: Boolean ->
        if (isGranted) {
            Log.d("MainActivity", "âœ… í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨")
            // Firebase í† í° ê°€ì ¸ì˜¤ê¸° ë° ì„œë²„ ë“±ë¡
            FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->
                if (task.isSuccessful) {
                    val token = task.result
                    Log.d("MainActivity", "Firebase í† í°: $token")
                    // ì„œë²„ì— í† í° ë“±ë¡ (ì§ì ‘ API í˜¸ì¶œ)
                    registerTokenDirectly(token)
                } else {
                    Log.e("MainActivity", "Firebase í† í° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${task.exception}")
                }
            }
        } else {
            Log.d("MainActivity", "âŒ í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ë¨")
        }
    }
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        // Edge-to-Edge ë¹„í™œì„±í™” (targetSdk 35 í˜¸í™˜)
        // WindowInsetsControllerëŠ” onResumeì—ì„œ ì²˜ë¦¬í•˜ê±°ë‚˜ ì œê±°
        // WindowCompat.setDecorFitsSystemWindows(window, false)
        
        // í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ (Android 13 ì´ìƒ)
        Log.d("MainActivity", "Android ë²„ì „: ${Build.VERSION.SDK_INT}, TIRAMISU: ${Build.VERSION_CODES.TIRAMISU}")
        
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            val hasPermission = ContextCompat.checkSelfPermission(
                this,
                Manifest.permission.POST_NOTIFICATIONS
            ) == PackageManager.PERMISSION_GRANTED
            
            Log.d("MainActivity", "í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ: $hasPermission")
            
            if (!hasPermission) {
                Log.d("MainActivity", "í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ì¤‘...")
                requestPermissionLauncher.launch(Manifest.permission.POST_NOTIFICATIONS)
            } else {
                Log.d("MainActivity", "âœ… í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œ ì´ë¯¸ í—ˆìš©ë¨")
                // Firebase í† í° ê°€ì ¸ì˜¤ê¸° ë° ì„œë²„ ë“±ë¡
                FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->
                    if (task.isSuccessful) {
                        val token = task.result
                        Log.d("MainActivity", "Firebase í† í°: $token")
                        // ì„œë²„ì— í† í° ë“±ë¡ (ì§ì ‘ API í˜¸ì¶œ)
                        registerTokenDirectly(token)
                    } else {
                        Log.e("MainActivity", "Firebase í† í° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${task.exception}")
                    }
                }
            }
        } else {
            Log.d("MainActivity", "Android 13 ë¯¸ë§Œ - Firebase í† í° ê°€ì ¸ì˜¤ê¸°")
            // Android 13 ë¯¸ë§Œì—ì„œëŠ” ê¶Œí•œ ìš”ì²­ ì—†ì´ ë°”ë¡œ í† í° ê°€ì ¸ì˜¤ê¸°
            FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->
                if (task.isSuccessful) {
                    val token = task.result
                    Log.d("MainActivity", "Firebase í† í°: $token")
                    // ì„œë²„ì— í† í° ë“±ë¡ (ì§ì ‘ API í˜¸ì¶œ)
                    registerTokenDirectly(token)
                } else {
                    Log.e("MainActivity", "Firebase í† í° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${task.exception}")
                }
            }
        }
        
        setContent {
            FoodTruckApp(
                onWebViewCreated = { webView -> currentWebView = webView }
            )
        }
    }
    
    @Deprecated("Deprecated in Java")
    override fun onBackPressed() {
        // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì²˜ë¦¬
        when {
            currentWebView?.canGoBack() == true -> {
                // WebViewì—ì„œ ë’¤ë¡œê°€ê¸° ê°€ëŠ¥í•˜ë©´ WebView ë’¤ë¡œê°€ê¸°
                currentWebView?.goBack()
            }
            else -> {
                // ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì•± ì¢…ë£Œ
                super.onBackPressed()
            }
        }
    }
    
    // ì„œë²„ì— í† í° ì§ì ‘ ë“±ë¡ (targetSdk 35 í˜¸í™˜)
    private fun registerTokenDirectly(token: String) {
        Thread {
            try {
                val url = java.net.URL("https://truck.carrera74.com/api/fcm/token")
                val connection = url.openConnection() as java.net.HttpURLConnection
                
                connection.requestMethod = "POST"
                connection.setRequestProperty("Content-Type", "application/json")
                connection.setRequestProperty("User-Agent", "FoodTruckApp/1.0.0")
                connection.doOutput = true
                
                val requestBody = """
                    {
                        "token": "$token",
                        "deviceType": "android",
                        "deviceId": "android_device_${System.currentTimeMillis()}"
                    }
                """.trimIndent()
                
                connection.outputStream.use { outputStream ->
                    outputStream.write(requestBody.toByteArray())
                }
                
                val responseCode = connection.responseCode
                Log.d("MainActivity", "í† í° ë“±ë¡ ì„œë²„ ì‘ë‹µ ì½”ë“œ: $responseCode")
                
                if (responseCode == 200 || responseCode == 201) {
                    Log.d("MainActivity", "âœ… ì„œë²„ì— í† í° ë“±ë¡ ì„±ê³µ")
                } else {
                    Log.e("MainActivity", "âŒ í† í° ë“±ë¡ ì‹¤íŒ¨: $responseCode")
                    val errorResponse = connection.errorStream?.bufferedReader()?.readText()
                    Log.e("MainActivity", "ì˜¤ë¥˜ ì‘ë‹µ: $errorResponse")
                }
                
            } catch (e: Exception) {
                Log.e("MainActivity", "âŒ í† í° ë“±ë¡ ì„œë²„ í†µì‹  ì˜¤ë¥˜", e)
            }
        }.start()
    }
    
    // ì„œë²„ì— ì•Œë¦¼ ì„¤ì • ìƒíƒœ ì—…ë°ì´íŠ¸
    private fun updateNotificationSettings(notificationEnabled: Boolean, locationNotificationEnabled: Boolean) {
        // FCM í† í°ì„ ê°€ì ¸ì™€ì„œ ì„œë²„ì— ì•Œë¦¼ ì„¤ì • ìƒíƒœ ì—…ë°ì´íŠ¸
        FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->
            if (task.isSuccessful) {
                val token = task.result
                Log.d("NotificationSettings", "ì•Œë¦¼ ì„¤ì • ì—…ë°ì´íŠ¸: notification=$notificationEnabled, location=$locationNotificationEnabled, í† í°: $token")
                
                // ì„œë²„ì— ì•Œë¦¼ ì„¤ì • ìƒíƒœ ì—…ë°ì´íŠ¸ API í˜¸ì¶œ
                updateNotificationSettingsOnServer(token, notificationEnabled, locationNotificationEnabled)
            } else {
                Log.e("NotificationSettings", "FCM í† í° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨", task.exception)
            }
        }
    }
    
    // ì„œë²„ì—ì„œ ì•Œë¦¼ ì„¤ì • ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
    private fun loadNotificationSettingsFromServer(callback: (NotificationSettings) -> Unit) {
        // ê¸°ë³¸ê°’ìœ¼ë¡œ ì¦‰ì‹œ ì„¤ì • (ANR ë°©ì§€)
        callback(NotificationSettings(notificationEnabled = true, locationNotificationEnabled = true))
        
        // UI ìŠ¤ë ˆë“œì—ì„œ FCM í† í° ê°€ì ¸ì˜¤ê¸°
        FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->
            if (task.isSuccessful) {
                val token = task.result
                Log.d("NotificationSettings", "ì„œë²„ì—ì„œ ì•Œë¦¼ ì„¤ì • ì¡°íšŒ ì¤‘... í† í°: $token")
                
                // ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œì—ì„œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­
                Thread {
                    try {
                        val url = java.net.URL("https://truck.carrera74.com/api/fcm/tokens")
                        val connection = url.openConnection() as java.net.HttpURLConnection
                        
                        connection.requestMethod = "GET"
                        connection.setRequestProperty("Content-Type", "application/json")
                        connection.setRequestProperty("User-Agent", "FoodTruckApp/1.0.0")
                        connection.connectTimeout = 10000 // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
                        connection.readTimeout = 10000 // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
                        
                        val responseCode = connection.responseCode
                        Log.d("NotificationSettings", "ì„œë²„ ì‘ë‹µ ì½”ë“œ: $responseCode")
                    
                        if (responseCode == 200) {
                            val response = connection.inputStream.bufferedReader().readText()
                            Log.d("NotificationSettings", "ì„œë²„ ì‘ë‹µ: $response")
                            
                            // JSON íŒŒì‹±í•˜ì—¬ í˜„ì¬ í† í°ì˜ ì„¤ì • ì°¾ê¸°
                            val jsonObject = org.json.JSONObject(response)
                            val tokensArray = jsonObject.getJSONArray("tokens")
                            
                            var foundSettings = NotificationSettings(
                                notificationEnabled = true, // ê¸°ë³¸ê°’
                                locationNotificationEnabled = true
                            )
                            
                            for (i in 0 until tokensArray.length()) {
                                val tokenObj = tokensArray.getJSONObject(i)
                                if (tokenObj.getString("token") == token) {
                                    foundSettings = NotificationSettings(
                                        notificationEnabled = tokenObj.getBoolean("notificationEnabled"),
                                        locationNotificationEnabled = tokenObj.getBoolean("notificationEnabled") // ìœ„ì¹˜ ì•Œë¦¼ë„ ê°™ì€ ì„¤ì • ì‚¬ìš©
                                    )
                                    break
                                }
                            }
                            
                            Log.d("NotificationSettings", "âœ… ì„œë²„ì—ì„œ ì•Œë¦¼ ì„¤ì • ë¡œë“œ ì„±ê³µ: $foundSettings")
                            callback(foundSettings)
                            
                        } else {
                            Log.e("NotificationSettings", "âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: $responseCode")
                            callback(NotificationSettings(notificationEnabled = true, locationNotificationEnabled = true))
                        }
                        
                    } catch (e: Exception) {
                        Log.e("NotificationSettings", "âŒ ì„œë²„ì—ì„œ ì•Œë¦¼ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨", e)
                        callback(NotificationSettings(notificationEnabled = true, locationNotificationEnabled = true))
                    }
                }.start()
                
            } else {
                Log.e("NotificationSettings", "FCM í† í° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨", task.exception)
                callback(NotificationSettings(notificationEnabled = true, locationNotificationEnabled = true))
            }
        }
    }
    
    // ì„œë²„ì— ì•Œë¦¼ ì„¤ì • ìƒíƒœ ì—…ë°ì´íŠ¸ API í˜¸ì¶œ
    private fun updateNotificationSettingsOnServer(token: String, notificationEnabled: Boolean, locationNotificationEnabled: Boolean) {
        Thread {
            try {
                val url = java.net.URL("https://truck.carrera74.com/api/fcm/token/$token")
                val connection = url.openConnection() as java.net.HttpURLConnection
                
                connection.requestMethod = "PATCH"
                connection.setRequestProperty("Content-Type", "application/json")
                connection.doOutput = true
                
                val requestBody = """
                    {
                        "notificationEnabled": $notificationEnabled,
                        "locationNotificationEnabled": $locationNotificationEnabled
                    }
                """.trimIndent()
                
                connection.outputStream.use { outputStream ->
                    outputStream.write(requestBody.toByteArray())
                }
                
                val responseCode = connection.responseCode
                Log.d("NotificationSettings", "ì„œë²„ ì‘ë‹µ ì½”ë“œ: $responseCode")
                
                if (responseCode == 200 || responseCode == 201) {
                    Log.d("NotificationSettings", "âœ… ì„œë²„ì— ì•Œë¦¼ ì„¤ì • ì—…ë°ì´íŠ¸ ì„±ê³µ")
                } else {
                    Log.e("NotificationSettings", "âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: $responseCode")
                    // ì‘ë‹µ ë‚´ìš© ì½ê¸°
                    val errorResponse = connection.errorStream?.bufferedReader()?.readText()
                    Log.e("NotificationSettings", "ì˜¤ë¥˜ ì‘ë‹µ: $errorResponse")
                }
                
            } catch (e: Exception) {
                Log.e("NotificationSettings", "âŒ ì„œë²„ í†µì‹  ì˜¤ë¥˜", e)
            }
        }.start()
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun LoadingScreen() {
    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color(254, 198, 80)), // ì•± í…Œë§ˆ ìƒ‰ìƒ
        contentAlignment = Alignment.Center
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.Center
        ) {
            CircularProgressIndicator(
                color = Color(101, 67, 33), // ë‹¤í¬ ë¸Œë¼ìš´ ìƒ‰ìƒ
                strokeWidth = 4.dp
            )
            Spacer(modifier = Modifier.height(16.dp))
            Text(
                text = "ë¡œë”© ì¤‘...",
                color = Color(101, 67, 33), // ë‹¤í¬ ë¸Œë¼ìš´ ìƒ‰ìƒ
                style = MaterialTheme.typography.bodyLarge
            )
        }
    }
}

@Composable
fun FoodTruckApp(
    onWebViewCreated: (WebView) -> Unit = {}
) {
        val viewModel: MainViewModel = viewModel()
        var webView by remember { mutableStateOf<WebView?>(null) }
        var currentUrl by remember { mutableStateOf(AppConfig.getMobileUrl() + "/") }
        var isWebViewLoading by remember { mutableStateOf(false) }
        var showNotificationSettings by remember { mutableStateOf(false) }
        
        // ViewModel ìƒíƒœ ê´€ì°°
        val isLoading by viewModel.isLoading.collectAsState()
        val error by viewModel.error.collectAsState()
        
        // ì—ëŸ¬ í‘œì‹œ
        error?.let { errorMessage ->
            LaunchedEffect(errorMessage) {
                // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ (Snackbar ë“±)
                viewModel.clearError()
            }
        }
        
        Column(modifier = Modifier.fillMaxSize()) {
                // Top App Bar
                @OptIn(ExperimentalMaterial3Api::class)
                TopAppBar(
                    title = { 
                        Text(
                            "ì„¸ì¢… ìœ ë¯¸ë„¤ ê³±ì°½ íŠ¸ëŸ­",
                            color = Color(101, 67, 33)
                        ) 
                    },
                    actions = {
                        Button(
                            onClick = { showNotificationSettings = true },
                            colors = ButtonDefaults.buttonColors(
                                containerColor = Color(101, 67, 33) // ë‹¤í¬ ë¸Œë¼ìš´ ìƒ‰ìƒ
                            ),
                            shape = RoundedCornerShape(6.dp),
                            modifier = Modifier.padding(end = 8.dp)
                        ) {
                            Text(
                                "ì•Œë¦¼",
                                color = Color.White,
                                style = MaterialTheme.typography.bodyMedium,
                                fontSize = 16.sp
                            )
                        }
                    },
                    colors = TopAppBarDefaults.topAppBarColors(
                        containerColor = Color(254, 198, 80),
                        titleContentColor = Color(101, 67, 33),
                        actionIconContentColor = Color(101, 67, 33)
                    )
                )
                
                // WebView ì˜ì—­
                Box(modifier = Modifier.weight(1f)) {
                    AndroidView(
                        factory = { context ->
                            WebView(context).apply {
                                settings.apply {
                                    javaScriptEnabled = true
                                    domStorageEnabled = true
                                    loadWithOverviewMode = true
                                    useWideViewPort = true
                                    builtInZoomControls = false
                                    displayZoomControls = false
                                    setSupportZoom(true)
                                    cacheMode = WebSettings.LOAD_NO_CACHE
                                    mixedContentMode = WebSettings.MIXED_CONTENT_ALWAYS_ALLOW
                                    
                                    // ìºì‹œ ì™„ì „ ë¹„í™œì„±í™”
                                    setDatabaseEnabled(false)
                                    setGeolocationEnabled(false)
                                    setRenderPriority(WebSettings.RenderPriority.HIGH)
                                }
                                
                                // ìºì‹œ ì™„ì „ ì‚­ì œ
                                clearCache(true)
                                clearHistory()
                                clearFormData()
                                
                                webViewClient = object : WebViewClient() {
                                    override fun onPageStarted(view: WebView?, url: String?, favicon: android.graphics.Bitmap?) {
                                        super.onPageStarted(view, url, favicon)
                                        isWebViewLoading = true
                                    }
                                    
                                    override fun onPageFinished(view: WebView?, url: String?) {
                                        super.onPageFinished(view, url)
                                        isWebViewLoading = false
                                    }
                                    
                                    override fun shouldOverrideUrlLoading(view: WebView?, url: String?): Boolean {
                                        url?.let { currentUrl ->
                                            when {
                                                currentUrl.startsWith("tel:") -> {
                                                    // ì „í™” ê±¸ê¸° Intent ìƒì„±
                                                    val intent = android.content.Intent(android.content.Intent.ACTION_DIAL, android.net.Uri.parse(currentUrl))
                                                    intent.addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK)
                                                    context.startActivity(intent)
                                                    return true
                                                }
                                                currentUrl.startsWith("mailto:") -> {
                                                    // ì´ë©”ì¼ Intent ìƒì„±
                                                    val intent = android.content.Intent(android.content.Intent.ACTION_SENDTO, android.net.Uri.parse(currentUrl))
                                                    intent.addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK)
                                                    context.startActivity(intent)
                                                    return true
                                                }
                                                currentUrl.startsWith("http://") || currentUrl.startsWith("https://") -> {
                                                    // ì™¸ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ê¸°
                                                    val intent = android.content.Intent(android.content.Intent.ACTION_VIEW, android.net.Uri.parse(currentUrl))
                                                    intent.addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK)
                                                    context.startActivity(intent)
                                                    return true
                                                }
                                                else -> {
                                                    // ë‹¤ë¥¸ URLì€ WebViewì—ì„œ ì²˜ë¦¬
                                                    return false
                                                }
                                            }
                                        }
                                        return false
                                    }
                                }
                                
                                // ìºì‹œ ë¬´ì‹œí•˜ê³  URL ë¡œë“œ
                                loadUrl("$currentUrl?t=${System.currentTimeMillis()}")
                                webView = this
                                onWebViewCreated(this)
                            }
                        },
                        modifier = Modifier.fillMaxSize()
                    )
                    
                    if (isWebViewLoading) {
                        LoadingScreen()
                    }
                    
                    // í•˜ë‹¨ ì „í™” ë²„íŠ¼ ì˜¤ë²„ë ˆì´
                    PhoneButtonOverlay()
                }
            }
            
            // ì•Œë¦¼ ì„¤ì • í™”ë©´ ì˜¤ë²„ë ˆì´
            if (showNotificationSettings) {
                NotificationSettingsScreen(
                    onBackClick = { 
                        showNotificationSettings = false
                    }
                )
            }
        }
    
    @Composable
    fun PhoneButtonOverlay() {
    val context = LocalContext.current
    
    Box(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp),
        contentAlignment = Alignment.BottomCenter
    ) {
        Button(
            onClick = {
                // ì „í™” ê±¸ê¸° Intent
                val intent = android.content.Intent(android.content.Intent.ACTION_DIAL)
                intent.data = android.net.Uri.parse("tel:010-2420-5174")
                context.startActivity(intent)
            },
            modifier = Modifier
                .fillMaxWidth()
                .height(50.dp),
            colors = ButtonDefaults.buttonColors(
                containerColor = Color(0xFF4CAF50) // ë…¹ìƒ‰
            ),
            shape = RoundedCornerShape(12.dp)
        ) {
            Text(
                text = "ğŸ“ ì£¼ì¸ì¥ì—ê²Œ ì „í™”í•˜ê¸°",
                color = Color.White,
                style = MaterialTheme.typography.bodyLarge,
                fontWeight = FontWeight.SemiBold
            )
        }
    }
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun NotificationSettingsScreen(
    onBackClick: () -> Unit
) {
    var isNotificationEnabled by remember { mutableStateOf(true) }
    var isLocationNotificationEnabled by remember { mutableStateOf(true) }
    var isLoading by remember { mutableStateOf(true) }
    var previousNotificationState by remember { mutableStateOf(false) }
    var previousLocationState by remember { mutableStateOf(false) }
    
    // ì„œë²„ì—ì„œ ì•Œë¦¼ ì„¤ì • ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
    LaunchedEffect(Unit) {
        loadNotificationSettingsFromServer { settings ->
            isNotificationEnabled = settings.notificationEnabled
            isLocationNotificationEnabled = settings.locationNotificationEnabled
            isLoading = false
        }
    }
    
    // ì „ì²´ í™”ë©´ì„ ë®ëŠ” ì˜¤ë²„ë ˆì´
    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.White)
    ) {
        if (isLoading) {
            // ë¡œë”© ì¤‘ í‘œì‹œ
            Box(
                modifier = Modifier.fillMaxSize(),
                contentAlignment = androidx.compose.ui.Alignment.Center
            ) {
                CircularProgressIndicator(
                    color = Color(254, 198, 80)
                )
            }
        } else {
            Column(
                modifier = Modifier.fillMaxSize()
            ) {
            // Top App Bar
            TopAppBar(
                title = { Text("ì•Œë¦¼ ì„¤ì •") },
                navigationIcon = {
                    IconButton(onClick = onBackClick) {
                        Icon(
                            imageVector = androidx.compose.material.icons.Icons.AutoMirrored.Filled.ArrowBack,
                            contentDescription = "ë’¤ë¡œê°€ê¸°",
                            tint = Color(101, 67, 33) // ë‹¤í¬ ë¸Œë¼ìš´ ìƒ‰ìƒ
                        )
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = Color(254, 198, 80), // ë©”ì¸ ë…¸ë‘ìƒ‰í†¤ê³¼ ë™ì¼
                    titleContentColor = Color(101, 67, 33) // ë‹¤í¬ ë¸Œë¼ìš´ ìƒ‰ìƒ
                )
            )
            
            // ì•Œë¦¼ ì„¤ì • ë‚´ìš©
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(16.dp),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                Text(
                    text = "í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •",
                    style = MaterialTheme.typography.headlineSmall
                )
                
                // ì „ì²´ ì•Œë¦¼ ì„¤ì •
                Card(
                    modifier = Modifier.fillMaxWidth(),
                    colors = CardDefaults.cardColors(
                        containerColor = Color(254, 198, 80) // ë…¸ë‘ìƒ‰ ê³„ì—´ ë°°ê²½
                    )
                ) {
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(16.dp),
                        horizontalArrangement = Arrangement.SpaceBetween,
                        verticalAlignment = androidx.compose.ui.Alignment.CenterVertically
                    ) {
                        Column {
                            Text(
                                text = "í‘¸ì‹œ ì•Œë¦¼",
                                style = MaterialTheme.typography.bodyLarge
                            )
                            Text(
                                text = "ëª¨ë“  ì•Œë¦¼ì„ ì¼œê±°ë‚˜ ë•ë‹ˆë‹¤",
                                style = MaterialTheme.typography.bodySmall,
                                color = MaterialTheme.colorScheme.onSurfaceVariant
                            )
                        }
                        Switch(
                            checked = isNotificationEnabled,
                            onCheckedChange = { 
                                // ì´ì „ ìƒíƒœ ì €ì¥
                                previousNotificationState = !it
                                
                                isNotificationEnabled = it
                                
                                // í‘¸ì‹œ ì•Œë¦¼ì´ ì¼œì§€ë©´ ìœ„ì¹˜ ì•Œë¦¼ë„ ìë™ìœ¼ë¡œ ì¼œê¸°
                                if (it) {
                                    isLocationNotificationEnabled = true
                                } else {
                                    // í‘¸ì‹œ ì•Œë¦¼ì´ êº¼ì§€ë©´ ìœ„ì¹˜ ì•Œë¦¼ë„ ë„ê¸°
                                    isLocationNotificationEnabled = false
                                }
                                
                                // ì„œë²„ì— ì•Œë¦¼ ì„¤ì • ìƒíƒœ ì—…ë°ì´íŠ¸
                                updateNotificationSettings(it, isLocationNotificationEnabled)
                            }
                        )
                    }
                }
                
                // ìœ„ì¹˜ ì•Œë¦¼ ì„¤ì •
                Card(
                    modifier = Modifier.fillMaxWidth(),
                    colors = CardDefaults.cardColors(
                        containerColor = Color(254, 198, 80) // ë…¸ë‘ìƒ‰ ê³„ì—´ ë°°ê²½
                    )
                ) {
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(16.dp),
                        horizontalArrangement = Arrangement.SpaceBetween,
                        verticalAlignment = androidx.compose.ui.Alignment.CenterVertically
                    ) {
                        Column {
                            Text(
                                text = "ìœ„ì¹˜ ì•Œë¦¼",
                                style = MaterialTheme.typography.bodyLarge
                            )
                            Text(
                                text = "í‘¸ë“œíŠ¸ëŸ­ ìœ„ì¹˜ ë³€ê²½ ì•Œë¦¼",
                                style = MaterialTheme.typography.bodySmall,
                                color = MaterialTheme.colorScheme.onSurfaceVariant
                            )
                        }
                        Switch(
                            checked = isLocationNotificationEnabled && isNotificationEnabled,
                            onCheckedChange = { 
                                // ì´ì „ ìƒíƒœ ì €ì¥
                                previousLocationState = !it
                                
                                isLocationNotificationEnabled = it
                                
                                // ì„œë²„ì— ì•Œë¦¼ ì„¤ì • ìƒíƒœ ì—…ë°ì´íŠ¸
                                updateNotificationSettings(isNotificationEnabled, it)
                            },
                            enabled = isNotificationEnabled
                        )
                    }
                }
                
                Spacer(modifier = Modifier.weight(1f))
            }
        }
    }
}