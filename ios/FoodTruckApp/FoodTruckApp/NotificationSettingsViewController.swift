import UIKit
import UserNotifications
import Firebase
import FirebaseMessaging

class NotificationSettingsViewController: UIViewController {
    
    // MARK: - Properties
    private var scrollView: UIScrollView!
    private var contentView: UIView!
    
    private var pushNotificationSwitch: UISwitch!
    private var locationNotificationSwitch: UISwitch!
    
    // UserDefaults ÌÇ§
    private let pushNotificationKey = "isPushNotificationEnabled"
    private let locationNotificationKey = "isLocationNotificationEnabled"
    
    // ÏÑúÎ≤Ñ API URL
    private let baseURL = "https://truck.carrera74.com"
    
    // MARK: - Lifecycle
    override func viewDidLoad() {
        super.viewDidLoad()
        setupUI()
        checkNotificationPermission()
        loadSettingsFromServer()
    }
    
    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î ÏÑ§Ï†ï Ïû¨Ï†ÅÏö©
        setupNavigationBar()
        // ÌôîÎ©¥Ïù¥ ÎÇòÌÉÄÎÇ† ÎïåÎßàÎã§ Í∂åÌïú ÏÉÅÌÉú ÌôïÏù∏
        checkNotificationPermission()
    }
    
    // MARK: - UI Setup
    private func setupUI() {
        view.backgroundColor = .white
        
        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î ÏÑ§Ï†ï
        setupNavigationBar()
        
        // Ïä§ÌÅ¨Î°§Î∑∞ ÏÑ§Ï†ï
        setupScrollView()
        
        // ÏΩòÌÖêÏ∏† ÏÑ§Ï†ï
        setupContent()
    }
    
    private func setupNavigationBar() {
        title = "ÏïåÎ¶º ÏÑ§Ï†ï"
        
        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î ÏÑ§Ï†ï
        navigationController?.navigationBar.backgroundColor = UIColor(red: 254/255, green: 198/255, blue: 80/255, alpha: 1.0)
        navigationController?.navigationBar.barTintColor = UIColor(red: 254/255, green: 198/255, blue: 80/255, alpha: 1.0)
        navigationController?.navigationBar.tintColor = UIColor(red: 101/255, green: 67/255, blue: 33/255, alpha: 1.0)
        
        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î Ïä§ÌÉÄÏùº ÏÑ§Ï†ï
        navigationController?.navigationBar.isTranslucent = false
        navigationController?.navigationBar.prefersLargeTitles = false
        
        // ÌÉÄÏù¥ÌãÄ ÏÉâÏÉÅ Î∞è Ìè∞Ìä∏ ÏÑ§Ï†ï
        navigationController?.navigationBar.titleTextAttributes = [
            .foregroundColor: UIColor(red: 101/255, green: 67/255, blue: 33/255, alpha: 1.0),
            .font: UIFont.systemFont(ofSize: 18, weight: .semibold)
        ]
        
        // Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäº
        let backButton = UIBarButtonItem(
            image: UIImage(systemName: "chevron.left"),
            style: .plain,
            target: self,
            action: #selector(backButtonTapped)
        )
        backButton.tintColor = UIColor(red: 101/255, green: 67/255, blue: 33/255, alpha: 1.0)
        navigationItem.leftBarButtonItem = backButton
        
        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î Î†àÏù¥ÏïÑÏõÉ Ï°∞Ï†ï
        if #available(iOS 15.0, *) {
            let appearance = UINavigationBarAppearance()
            appearance.configureWithOpaqueBackground()
            appearance.backgroundColor = UIColor(red: 254/255, green: 198/255, blue: 80/255, alpha: 1.0)
            appearance.titleTextAttributes = [
                .foregroundColor: UIColor(red: 101/255, green: 67/255, blue: 33/255, alpha: 1.0),
                .font: UIFont.systemFont(ofSize: 18, weight: .semibold)
            ]
            navigationController?.navigationBar.standardAppearance = appearance
            navigationController?.navigationBar.scrollEdgeAppearance = appearance
        }
    }
    
    private func setupScrollView() {
        scrollView = UIScrollView()
        scrollView.translatesAutoresizingMaskIntoConstraints = false
        view.addSubview(scrollView)
        
        contentView = UIView()
        contentView.translatesAutoresizingMaskIntoConstraints = false
        scrollView.addSubview(contentView)
        
        NSLayoutConstraint.activate([
            scrollView.topAnchor.constraint(equalTo: view.safeAreaLayoutGuide.topAnchor),
            scrollView.leadingAnchor.constraint(equalTo: view.leadingAnchor),
            scrollView.trailingAnchor.constraint(equalTo: view.trailingAnchor),
            scrollView.bottomAnchor.constraint(equalTo: view.safeAreaLayoutGuide.bottomAnchor),
            
            contentView.topAnchor.constraint(equalTo: scrollView.topAnchor),
            contentView.leadingAnchor.constraint(equalTo: scrollView.leadingAnchor),
            contentView.trailingAnchor.constraint(equalTo: scrollView.trailingAnchor),
            contentView.bottomAnchor.constraint(equalTo: scrollView.bottomAnchor),
            contentView.widthAnchor.constraint(equalTo: scrollView.widthAnchor)
        ])
    }
    
    private func setupContent() {
        let stackView = UIStackView()
        stackView.axis = .vertical
        stackView.spacing = 16
        stackView.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(stackView)
        
        NSLayoutConstraint.activate([
            stackView.topAnchor.constraint(equalTo: contentView.topAnchor, constant: 16),
            stackView.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 16),
            stackView.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -16),
            stackView.bottomAnchor.constraint(equalTo: contentView.bottomAnchor, constant: -16)
        ])
        
        // Ï†úÎ™©
        let titleLabel = UILabel()
        titleLabel.text = "Ìë∏Ïãú ÏïåÎ¶º ÏÑ§Ï†ï"
        titleLabel.font = UIFont.systemFont(ofSize: 24, weight: .bold)
        titleLabel.textColor = UIColor(red: 101/255, green: 67/255, blue: 33/255, alpha: 1.0)
        stackView.addArrangedSubview(titleLabel)
        
        // Ï†ÑÏ≤¥ ÏïåÎ¶º ÏÑ§Ï†ï
        let pushNotificationCard = createSettingCard(
            title: "Ìë∏Ïãú ÏïåÎ¶º",
            subtitle: "Î™®Îì† ÏïåÎ¶ºÏùÑ ÏºúÍ±∞ÎÇò ÎÅïÎãàÎã§",
            switchAction: #selector(pushNotificationChanged(_:))
        )
        pushNotificationSwitch = pushNotificationCard.1
        stackView.addArrangedSubview(pushNotificationCard.0)
        
        
        // ÏúÑÏπò ÏïåÎ¶º ÏÑ§Ï†ï
        let locationNotificationCard = createSettingCard(
            title: "ÏúÑÏπò ÏïåÎ¶º",
            subtitle: "Ìë∏ÎìúÌä∏Îü≠ ÏúÑÏπò Î≥ÄÍ≤Ω ÏïåÎ¶º",
            switchAction: #selector(locationNotificationChanged(_:))
        )
        locationNotificationSwitch = locationNotificationCard.1
        stackView.addArrangedSubview(locationNotificationCard.0)
        
        // Ïä§ÌéòÏù¥ÏÑú
        let spacer = UIView()
        spacer.translatesAutoresizingMaskIntoConstraints = false
        spacer.heightAnchor.constraint(greaterThanOrEqualToConstant: 20).isActive = true
        stackView.addArrangedSubview(spacer)
        
        // Ï†ÄÏû• Î≤ÑÌäº
        let saveButton = UIButton(type: .system)
        saveButton.setTitle("Ï†ÄÏû•", for: .normal)
        saveButton.backgroundColor = UIColor(red: 254/255, green: 198/255, blue: 80/255, alpha: 1.0)
        saveButton.setTitleColor(UIColor(red: 101/255, green: 67/255, blue: 33/255, alpha: 1.0), for: .normal)
        saveButton.titleLabel?.font = UIFont.systemFont(ofSize: 18, weight: .semibold)
        saveButton.layer.cornerRadius = 12
        saveButton.translatesAutoresizingMaskIntoConstraints = false
        saveButton.heightAnchor.constraint(equalToConstant: 50).isActive = true
        saveButton.addTarget(self, action: #selector(saveButtonTapped), for: .touchUpInside)
        stackView.addArrangedSubview(saveButton)
    }
    
    private func createSettingCard(title: String, subtitle: String, switchAction: Selector) -> (UIView, UISwitch) {
        let cardView = UIView()
        cardView.backgroundColor = UIColor(red: 254/255, green: 198/255, blue: 80/255, alpha: 1.0)
        cardView.layer.cornerRadius = 12
        cardView.translatesAutoresizingMaskIntoConstraints = false
        
        let contentStack = UIStackView()
        contentStack.axis = .horizontal
        contentStack.spacing = 16
        contentStack.alignment = .center
        contentStack.translatesAutoresizingMaskIntoConstraints = false
        cardView.addSubview(contentStack)
        
        // ÌÖçÏä§Ìä∏ Ïä§ÌÉù
        let textStack = UIStackView()
        textStack.axis = .vertical
        textStack.spacing = 4
        
        let titleLabel = UILabel()
        titleLabel.text = title
        titleLabel.font = UIFont.systemFont(ofSize: 17, weight: .semibold)
        titleLabel.textColor = UIColor(red: 101/255, green: 67/255, blue: 33/255, alpha: 1.0)
        
        let subtitleLabel = UILabel()
        subtitleLabel.text = subtitle
        subtitleLabel.font = UIFont.systemFont(ofSize: 14, weight: .regular)
        subtitleLabel.textColor = UIColor(red: 101/255, green: 67/255, blue: 33/255, alpha: 0.7)
        subtitleLabel.numberOfLines = 0
        
        textStack.addArrangedSubview(titleLabel)
        textStack.addArrangedSubview(subtitleLabel)
        
        // Ïä§ÏúÑÏπò
        let toggleSwitch = UISwitch()
        toggleSwitch.onTintColor = UIColor(red: 101/255, green: 67/255, blue: 33/255, alpha: 1.0)
        toggleSwitch.addTarget(self, action: switchAction, for: .valueChanged)
        
        contentStack.addArrangedSubview(textStack)
        contentStack.addArrangedSubview(toggleSwitch)
        
        NSLayoutConstraint.activate([
            contentStack.topAnchor.constraint(equalTo: cardView.topAnchor, constant: 16),
            contentStack.leadingAnchor.constraint(equalTo: cardView.leadingAnchor, constant: 16),
            contentStack.trailingAnchor.constraint(equalTo: cardView.trailingAnchor, constant: -16),
            contentStack.bottomAnchor.constraint(equalTo: cardView.bottomAnchor, constant: -16)
        ])
        
        return (cardView, toggleSwitch)
    }
    
    // MARK: - Actions
    @objc private func backButtonTapped() {
        print("üîô Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠")
        
        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î Ïà®Í∏∞Í∏∞ (Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†úÍ±∞)
        navigationController?.setNavigationBarHidden(true, animated: false)
        
        navigationController?.popViewController(animated: true)
    }
    
    @objc private func pushNotificationChanged(_ sender: UISwitch) {
        print("üîî Ï†ÑÏ≤¥ Ìë∏Ïãú ÏïåÎ¶º Î≥ÄÍ≤Ω: \(sender.isOn)")
        
        if sender.isOn {
            // Í∂åÌïú ÏÉÅÌÉú ÌôïÏù∏
            UNUserNotificationCenter.current().getNotificationSettings { settings in
                DispatchQueue.main.async {
                    switch settings.authorizationStatus {
                    case .authorized, .provisional:
                        // Í∂åÌïúÏù¥ ÌóàÏö©Îêú Í≤ΩÏö∞ - Ï†ïÏÉÅ ÎèôÏûë
                        self.locationNotificationSwitch.isEnabled = true
                        // ÏÑúÎ≤ÑÏóê ÏÑ§Ï†ï Ï†ÄÏû•
                        self.saveSettingsToServer()
                    case .denied:
                        // Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêú Í≤ΩÏö∞ - OS ÏÑ§Ï†ïÏúºÎ°ú Ïù¥Îèô
                        sender.isOn = false // Ïä§ÏúÑÏπòÎ•º Îã§Ïãú OFFÎ°ú
                        self.showPermissionDeniedAlert()
                    case .notDetermined:
                        // Í∂åÌïúÏù¥ ÎØ∏Í≤∞Ï†ïÏù∏ Í≤ΩÏö∞ - Í∂åÌïú ÏöîÏ≤≠
                        self.requestNotificationPermission()
                    @unknown default:
                        break
                    }
                }
            }
        } else {
            // Ï†ÑÏ≤¥ ÏïåÎ¶ºÏù¥ Í∫ºÏßÄÎ©¥ ÌïòÏúÑ ÏïåÎ¶ºÎèÑ ÎπÑÌôúÏÑ±Ìôî Î∞è OFF
            locationNotificationSwitch.isOn = false
            locationNotificationSwitch.isEnabled = false
            // ÏÑúÎ≤ÑÏóê ÏÑ§Ï†ï Ï†ÄÏû•
            saveSettingsToServer()
        }
    }
    
    
    @objc private func locationNotificationChanged(_ sender: UISwitch) {
        print("üìç ÏúÑÏπò ÏïåÎ¶º Î≥ÄÍ≤Ω: \(sender.isOn)")
        // ÏÑúÎ≤ÑÏóê ÏÑ§Ï†ï Ï†ÄÏû•
        saveSettingsToServer()
    }
    
    @objc private func saveButtonTapped() {
        print("üíæ ÏïåÎ¶º ÏÑ§Ï†ï Ï†ÄÏû•")
        
        // ÏÑúÎ≤ÑÏóê ÏÑ§Ï†ï Ï†ÄÏû•
        saveSettingsToServer()
    }
    
    // MARK: - Settings Management
    private func loadSettings() {
        let isPushEnabled = UserDefaults.standard.bool(forKey: pushNotificationKey)
        let isLocationEnabled = UserDefaults.standard.bool(forKey: locationNotificationKey)
        
        // Ï≤òÏùå Ïã§Ìñâ Ïãú Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
        if !UserDefaults.standard.bool(forKey: "hasLaunchedBefore") {
            UserDefaults.standard.set(true, forKey: pushNotificationKey)
            UserDefaults.standard.set(true, forKey: locationNotificationKey)
            UserDefaults.standard.set(true, forKey: "hasLaunchedBefore")
            
            pushNotificationSwitch.isOn = true
            locationNotificationSwitch.isOn = true
        } else {
            pushNotificationSwitch.isOn = isPushEnabled
            locationNotificationSwitch.isOn = isLocationEnabled
        }
        
        // Ï†ÑÏ≤¥ ÏïåÎ¶ºÏù¥ Í∫ºÏ†∏ÏûàÏúºÎ©¥ ÌïòÏúÑ ÏïåÎ¶º ÎπÑÌôúÏÑ±Ìôî
        locationNotificationSwitch.isEnabled = isPushEnabled
    }
    
    private func saveSettings() {
        UserDefaults.standard.set(pushNotificationSwitch.isOn, forKey: pushNotificationKey)
        UserDefaults.standard.set(locationNotificationSwitch.isOn, forKey: locationNotificationKey)
        UserDefaults.standard.synchronize()
        
        print("‚úÖ ÏïåÎ¶º ÏÑ§Ï†ï Ï†ÄÏû• ÏôÑÎ£å:")
        print("   - Ìë∏Ïãú ÏïåÎ¶º: \(pushNotificationSwitch.isOn)")
        print("   - ÏúÑÏπò ÏïåÎ¶º: \(locationNotificationSwitch.isOn)")
    }
    
    // MARK: - Notification Permission
    private func checkNotificationPermission() {
        UNUserNotificationCenter.current().getNotificationSettings { settings in
            DispatchQueue.main.async {
                switch settings.authorizationStatus {
                case .authorized, .provisional:
                    print("‚úÖ ÏïåÎ¶º Í∂åÌïú ÌóàÏö©Îê®")
                    self.enableNotificationControls()
                case .denied:
                    print("‚ùå ÏïåÎ¶º Í∂åÌïú Í±∞Î∂ÄÎê®")
                    self.disableNotificationControls()
                case .notDetermined:
                    print("‚ö†Ô∏è ÏïåÎ¶º Í∂åÌïú ÎØ∏Í≤∞Ï†ï")
                    self.enableNotificationControls()
                @unknown default:
                    break
                }
            }
        }
    }
    
    private func enableNotificationControls() {
        pushNotificationSwitch.isEnabled = true
        locationNotificationSwitch.isEnabled = true
    }
    
    private func disableNotificationControls() {
        // Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêú Í≤ΩÏö∞ Î™®Îì† Ïä§ÏúÑÏπòÎ•º OFFÎ°ú ÏÑ§Ï†ïÌïòÍ≥† ÎπÑÌôúÏÑ±Ìôî
        pushNotificationSwitch.isOn = false
        locationNotificationSwitch.isOn = false
        pushNotificationSwitch.isEnabled = false
        locationNotificationSwitch.isEnabled = false
    }
    
    private func requestNotificationPermission() {
        UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .badge, .sound]) { granted, error in
            DispatchQueue.main.async {
                if granted {
                    print("‚úÖ ÏïåÎ¶º Í∂åÌïú ÌóàÏö©Îê®")
                    UIApplication.shared.registerForRemoteNotifications()
                } else {
                    print("‚ùå ÏïåÎ¶º Í∂åÌïú Í±∞Î∂ÄÎê®")
                    self.pushNotificationSwitch.isOn = false
                    self.showPermissionDeniedAlert()
                }
            }
        }
    }
    
    private func showPermissionDeniedAlert() {
        let alert = UIAlertController(
            title: "ÏïåÎ¶º ÏÑ§Ï†ï ÌïÑÏöî",
            message: "Ïï±ÏÑ§Ï†ïÏóêÏÑú Ìë∏ÏãúÏÑ§Ï†ïÏùÑ ÏºúÏïºÌï©ÎãàÎã§.\nÏÑ§Ï†ï Ïï±ÏóêÏÑú ÏïåÎ¶º Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.",
            preferredStyle: .alert
        )
        
        alert.addAction(UIAlertAction(title: "ÏÑ§Ï†ïÏúºÎ°ú Ïù¥Îèô", style: .default) { _ in
            if let url = URL(string: UIApplication.openSettingsURLString) {
                UIApplication.shared.open(url)
            }
        })
        
        alert.addAction(UIAlertAction(title: "Ï∑®ÏÜå", style: .cancel))
        
        present(alert, animated: true)
    }
    
    // MARK: - Server API
    private func loadSettingsFromServer() {
        // Î®ºÏ†Ä Î°úÏª¨ ÏÑ§Ï†ïÏúºÎ°ú UI Ï¥àÍ∏∞Ìôî
        loadSettings()
        
        // FCM ÌÜ†ÌÅ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        Messaging.messaging().token { [weak self] (token: String?, error: Error?) in
            if let error = error {
                print("‚ùå FCM ÌÜ†ÌÅ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®: \(error)")
                return
            }
            
            guard let token = token else {
                print("‚ùå FCM ÌÜ†ÌÅ∞Ïù¥ nil")
                return
            }
            
            print("‚úÖ FCM ÌÜ†ÌÅ∞: \(token)")
            self?.fetchNotificationSettings(token: token)
        }
    }
    
    private func fetchNotificationSettings(token: String) {
        guard let url = URL(string: "\(baseURL)/api/fcm/tokens") else {
            print("‚ùå ÏûòÎ™ªÎêú URL")
            return
        }
        
        var request = URLRequest(url: url)
        request.httpMethod = "GET"
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        request.setValue("FoodTruckApp/1.0.0", forHTTPHeaderField: "User-Agent")
        
        URLSession.shared.dataTask(with: request) { [weak self] data, response, error in
            DispatchQueue.main.async {
                if let error = error {
                    print("‚ùå ÏÑúÎ≤Ñ ÌÜµÏã† Ïò§Î•ò: \(error)")
                    return
                }
                
                guard let data = data else {
                    print("‚ùå ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå")
                    return
                }
                
                do {
                    if let json = try JSONSerialization.jsonObject(with: data) as? [String: Any],
                       let tokens = json["tokens"] as? [[String: Any]] {
                        print("üì± ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ ÌÜ†ÌÅ∞ Î™©Î°ù: \(json)")
                        
                        // ÌòÑÏû¨ ÌÜ†ÌÅ∞Ïóê Ìï¥ÎãπÌïòÎäî ÏÑ§Ï†ï Ï∞æÍ∏∞
                        var notificationEnabled = true
                        var locationNotificationEnabled = true
                        
                        for tokenData in tokens {
                            if let tokenValue = tokenData["token"] as? String, tokenValue == token {
                                notificationEnabled = tokenData["notificationEnabled"] as? Bool ?? true
                                locationNotificationEnabled = tokenData["locationNotificationEnabled"] as? Bool ?? true
                                break
                            }
                        }
                        
                        // UI ÏóÖÎç∞Ïù¥Ìä∏
                        self?.pushNotificationSwitch.isOn = notificationEnabled
                        self?.locationNotificationSwitch.isOn = locationNotificationEnabled
                        self?.locationNotificationSwitch.isEnabled = notificationEnabled
                        
                        // Î°úÏª¨ÏóêÎèÑ Ï†ÄÏû•
                        UserDefaults.standard.set(notificationEnabled, forKey: self?.pushNotificationKey ?? "")
                        UserDefaults.standard.set(locationNotificationEnabled, forKey: self?.locationNotificationKey ?? "")
                        UserDefaults.standard.synchronize()
                        
                        print("‚úÖ ÏÑúÎ≤ÑÏóêÏÑú ÏïåÎ¶º ÏÑ§Ï†ï Î°úÎìú ÏôÑÎ£å - Ìë∏Ïãú: \(notificationEnabled), ÏúÑÏπò: \(locationNotificationEnabled)")
                    }
                } catch {
                    print("‚ùå JSON ÌååÏã± Ïò§Î•ò: \(error)")
                }
            }
        }.resume()
    }
    
    private func saveSettingsToServer() {
        Messaging.messaging().token { [weak self] (token: String?, error: Error?) in
            if let error = error {
                print("‚ùå FCM ÌÜ†ÌÅ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®: \(error)")
                self?.showErrorAlert(message: "FCM ÌÜ†ÌÅ∞ÏùÑ Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.")
                return
            }
            
            guard let token = token else {
                print("‚ùå FCM ÌÜ†ÌÅ∞Ïù¥ nil")
                self?.showErrorAlert(message: "FCM ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏäµÎãàÎã§.")
                return
            }
            
            self?.updateNotificationSettingsOnServer(token: token)
        }
    }
    
    private func updateNotificationSettingsOnServer(token: String) {
        guard let url = URL(string: "\(baseURL)/api/fcm/token/\(token)") else {
            print("‚ùå ÏûòÎ™ªÎêú URL")
            showErrorAlert(message: "ÏûòÎ™ªÎêú ÏÑúÎ≤Ñ URLÏûÖÎãàÎã§.")
            return
        }
        
        var request = URLRequest(url: url)
        request.httpMethod = "PATCH"
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        request.setValue("FoodTruckApp/1.0.0", forHTTPHeaderField: "User-Agent")
        
        let requestBody: [String: Any] = [
            "notificationEnabled": pushNotificationSwitch.isOn,
            "locationNotificationEnabled": locationNotificationSwitch.isOn
        ]
        
        do {
            request.httpBody = try JSONSerialization.data(withJSONObject: requestBody)
        } catch {
            print("‚ùå JSON ÏßÅÎ†¨Ìôî Ïò§Î•ò: \(error)")
            showErrorAlert(message: "ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")
            return
        }
        
        URLSession.shared.dataTask(with: request) { [weak self] data, response, error in
            DispatchQueue.main.async {
                if let error = error {
                    print("‚ùå ÏÑúÎ≤Ñ ÌÜµÏã† Ïò§Î•ò: \(error)")
                    self?.showErrorAlert(message: "ÏÑúÎ≤Ñ ÌÜµÏã†Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")
                    return
                }
                
                if let httpResponse = response as? HTTPURLResponse {
                    print("üì± ÏÑúÎ≤Ñ ÏùëÎãµ ÏΩîÎìú: \(httpResponse.statusCode)")
                    
                    if httpResponse.statusCode == 200 || httpResponse.statusCode == 201 {
                        // ÏÑ±Í≥µ
                        self?.saveSettings() // Î°úÏª¨ÏóêÎèÑ Ï†ÄÏû•
                        self?.showSuccessAlert()
                    } else {
                        print("‚ùå ÏÑúÎ≤Ñ Ïò§Î•ò: \(httpResponse.statusCode)")
                        self?.showErrorAlert(message: "ÏÑúÎ≤ÑÏóêÏÑú Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")
                    }
                }
            }
        }.resume()
    }
    
    private func showSuccessAlert() {
        let alert = UIAlertController(
            title: "Ï†ÄÏû• ÏôÑÎ£å",
            message: "ÏïåÎ¶º ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.",
            preferredStyle: .alert
        )
        alert.addAction(UIAlertAction(title: "ÌôïÏù∏", style: .default) { [weak self] _ in
            // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î Ïà®Í∏∞Í∏∞
            self?.navigationController?.setNavigationBarHidden(true, animated: true)
            self?.navigationController?.popViewController(animated: true)
        })
        present(alert, animated: true)
    }
    
    private func showErrorAlert(message: String) {
        let alert = UIAlertController(
            title: "Ïò§Î•ò",
            message: message,
            preferredStyle: .alert
        )
        alert.addAction(UIAlertAction(title: "ÌôïÏù∏", style: .default))
        present(alert, animated: true)
    }
}

